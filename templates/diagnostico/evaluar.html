{% extends 'base.html' %}
{% block title %}Evaluar equipo – Diagnóstico{% endblock %}

{% block content %}
<h2 class="mb-4">Evaluar Equipo Asignado</h2>

{% if messages %}
  {% for message in messages %}
    <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}" role="alert">
      {{ message }}
    </div>
  {% endfor %}
{% endif %}

<div class="card p-4 shadow-sm border-0">

  {% if asignaciones %}
    <!-- Selector de asignación (estudiante + equipo) -->
    <form method="get" class="mb-4">
      <div class="mb-2">
        <label class="form-label">Seleccionar estudiante / equipo asignado</label>
        <select name="idx" class="form-select" onchange="this.form.submit()">
          {% for a in asignaciones %}
            <option value="{{ a.idx }}" {% if a.idx == idx_actual %}selected{% endif %}>
              {{ a.estudiante }} – {{ a.equipo.nombre }} ({{ a.equipo.tipo }})
            </option>
          {% endfor %}
        </select>
      </div>
    </form>

    <!-- Formulario de diagnóstico para la asignación seleccionada -->
    <form method="post">
      {% csrf_token %}
      <!-- Índice de la asignación actualmente seleccionada -->
      <input type="hidden" name="idx" value="{{ idx_actual }}">

      <!-- Estudiante (prellenado y solo lectura) -->
      <div class="mb-3">
        <label class="form-label">Nombre del estudiante</label>
        <input type="text" name="estudiante" class="form-control"
               value="{{ estudiante_asignado }}" readonly>
      </div>

      <!-- Equipo asignado (info en solo lectura) -->
      <div class="mb-3">
        <label class="form-label">Equipo recepcionado</label>
        <div class="form-control-plaintext">
          <strong>{{ equipo_asignado.nombre }}</strong> – {{ equipo_asignado.tipo }}<br>
          <small class="text-muted">
            Problema: {{ equipo_asignado.problema }}<br>
            Estado actual: {{ equipo_asignado.get_estado_display }}
          </small>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Diagnóstico</label>
        <textarea name="diagnostico" class="form-control" rows="3"></textarea>
      </div>

      <!-- Tipo de solución: Preventiva / Correctiva -->
      <div class="mb-3">
        <label class="form-label d-block">Tipo de solución</label>

        <div class="btn-group" role="group" aria-label="Tipo de solución">
          <input type="radio" class="btn-check" name="tipo_solucion" id="tsPreventiva" value="Preventiva" autocomplete="off">
          <label class="btn btn-outline-secondary" for="tsPreventiva">Preventiva</label>

          <input type="radio" class="btn-check" name="tipo_solucion" id="tsCorrectiva" value="Correctiva" autocomplete="off">
          <label class="btn btn-outline-secondary" for="tsCorrectiva">Correctiva</label>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Detalle de la solución aplicada</label>
        <textarea name="solucion" class="form-control" rows="3"></textarea>
      </div>

      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">
          Guardar diagnóstico
        </button>
      </div>
    </form>

  {% else %}
    <div class="alert alert-warning" role="alert">
      No hay un equipo asignado en esta sesión.
      Primero debes asignar un equipo en la pantalla <strong>Asignar Equipo</strong>.
    </div>
    <a href="{% url 'asignar_equipo' %}" class="btn btn-outline-primary">
      Ir a asignar equipo
    </a>
  {% endif %}

</div>
{% endblock %}
